# 前端展示大量坐标点位的问题

city服务需要展示用户传感器所在位置（如果有自定义坐标的话），管理员可以进行全量查看。这在前期数据量很小的时候没有什么问题，但是随着业务拓展发现数据量增长很多的时候（10w+）就必须使用新的解决方案了，现有方案存在两个问题：

1. 在一个高阶用户的视角下，如果视野足够大，就必须加载很多点位数据，这会使得请求很多或者单个请求相当大以至于对后端服务压力很大。
2. 第二个是数据传输问题，所有数据由前端聚合，造成的结果是后端必须传输单个信息，即使足够精简，在数据量很大的情况下其体积也是很惊人的大，目前city的地图页打开一个页面仅传输就需要几十秒，并且这还是在做过字段整理，并且做过gzip压缩的情况下
3. 最后是前端的渲染问题，目前地图页使用高德地图自带的点聚合算法，处理如此多的数据势必消耗很多内存，而进行自由缩放后需要渲染太多的dom节点聚合动画，很容易造成页面的崩溃

所以后端聚合数据势在必行，后端聚合有两个好处：一个是减少传输数据，仅提供大视野的简要信息或者小视野下的几个坐标，性能上限可控，且表现稳定；第二个是前端所需渲染数据减少。在这个方案里前端需要做的事情很明确，那就是将自己的视野坐标及聚合粒度发送给后端并处理返回数据即可，这里返回数据和之前相比会有一些不同。后端聚合有很多种方法，仅考虑聚合效果的话geo-hash是个不错的解决方案，援引一篇对geo-hash深入浅出的介绍文章：[高效的多维空间点索引算法 — Geohash 和 Google S2](https://halfrost.com/go_spatial_search/)，这里介绍了两种空间点索引方案，google s2对与geo-hash的优势主要体现在临近值查询更加稳定，同时支持更精确的空间索引层级，geo-hash有12个层级，而s2有30个，相应cellid存储字段也更长，且需要专门的查询依赖，仅考虑目前需求的话geo-hash足矣。

具体解决方案为设备部署时根据坐标进行geohash，将结果存储，并建立text索引，在查询界面请求中解析出等级参数和中心点，依据中心点算出对应的hash值后，根据精度取不同长度的字符串表示进行聚合查询，后端返回前需要对结果进行预处理，多个点位的聚合结果需要整理出此点位的数量以及显示状态，单点位的聚合结果需要附带点位的设备类型、状态、sn、名称等信息，以方便前端使用