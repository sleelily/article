# 使用 npm module 在微服务架构中编写测试

微服务架构逐渐被更多的人在实际项目中考虑使用，但应该认识到微服务也并非银弹，除了带来的业务和开发上解耦和可伸缩部署等诸多好处外，微服务也带来了很多原本不存在的问题，如跨服务事务、查询和测试编写等。

### 服务隔离

在微服务中编写测试，我之前走了一些弯路，首先是没有考虑到服务隔离的重要性。由于开始整个架构中只有我将每个微服务所依赖的其他服务都写在了docker-compose文件中，这样做的好处是所有测试都可以调用真实接口，编写测试非常方便。但与此同时，这也耗费了很多资源，尤其当整个架构中的微服务逐渐增多时，ci/cd所占用的资源会成倍上升。除此之外，维护测试中整个集群，往往会面临来自其他干扰，比如其他服务版本升级导致的参数变化或者接口返回数据不在预期之内等等，在这种情况下很容易形成问题链，开发效率十分低下。整体来看优势远远无法弥补缺陷带来的痛苦，所以应该将测试中所依赖的服务隔离掉了。隔离服务当然要用到 stub function 了，我的项目测试框架是 jest，有更为方便的 spy 功能，可以同时校验传入的参数以及返回一份样本数据，如此一来就不需要实际依赖原有服务了。

![stub](https://miro.medium.com/max/1024/0*KdpZaEVy6GNnrUpB.png)

### 样本数据维护

现在我们不再需要同时在ci/cd中维护那么多服务了，但是又产生了新的问题，我们需要编写大量 stub 方法，同时我们必须知道所调用方法的预期返回数据，这样编写测试一下子痛苦了好多，因为编写上层服务的人不一定了解下层服务的返回数据，只能边翻文档边写样本数据边写测试，而一旦下层服务发生了变化那么上层服务又必须修改它们所维护的样本数据；另外一遍又一遍编写 jest.spyOn 等样本代码也是一件烦人的事。重新整理一下我们的需求：

1. 我们不想在调用方处维护样本数据，最好放在被调用方，但是被调用方已经被我们隔离掉了；
2. 我们不想在测试中一遍又一遍写stub function，最好被调用方提供一个“一键stub”的方法，但是被调用方已经被我们隔离掉了；

以上两方都需要被调用方参与，但是被调用方已经被隔离掉了，所以不能通过服务实现。那有什么比较好的途径呢？npm module 就是一个比较适合的方式，我们可以把被调用方的所有方法用 npm module 封装一遍，这样就很容易实现全局 stub 的方法，同时在 npm module 中也方便提供被调用的样本数据。

### 面向约定

实现到这里已经有点“面向约定编程”的意思了，那我们为什么不约定得更彻底一些呢？被调用方存在很多类型声明文件，调用方有时也会用到，不如也放在 npm module 中去。如果被调用方是 grpc 服务，所依赖的 protobuf 文件也可以放进 npm module。还有，如果下层服务所需要的测试数据也可以从 npm module 中获取。如此一来，我们就得到了一份调用方与被调用方之间的约定，我们只需要安装一份所依赖服务的 npm module 便可以简便地编写测试啦。